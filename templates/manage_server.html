<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flare Panel - Server Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- CodeMirror CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1c20;
            --bg-darker: #1f2937;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --accent: #ff6b35;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        
        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        
        .navbar {
            background: var(--bg-darker) !important;
            border-bottom: 1px solid var(--border-color);
        }
        
        .nav-tabs {
            border: none;
            margin-bottom: 1rem;
            background: var(--bg-darker);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        
        .nav-tabs .nav-link {
            color: var(--text-secondary);
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border-radius: 0.375rem;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--text-primary);
            background: rgba(255, 107, 53, 0.1);
            border: none;
        }
        
        .card {
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }
        
        .card-header {
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem;
        }
        
        .console-container {
            background: #1a1c20;
            border-radius: 0.5rem;
            height: calc(100vh - 250px);
            min-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .console-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .console-input:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: var(--accent);
            color: var(--text-primary);
            box-shadow: none;
        }
        
        .file-manager {
            background: var(--bg-darker);
            border-radius: 0.5rem;
            height: calc(100vh - 250px);
            min-height: 400px;
            overflow-y: auto;
        }
        
        .breadcrumb {
            background: rgba(0, 0, 0, 0.2);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .breadcrumb-item a {
            color: var(--accent);
            text-decoration: none;
        }
        
        .breadcrumb-item.active {
            color: var(--text-secondary);
        }
        
        .file-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .file-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }
        
        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .file-item i {
            margin-right: 0.5rem;
            color: var(--accent);
        }
        
        .btn-primary {
            background: var(--accent);
            border: none;
        }
        
        .btn-primary:hover {
            background: #e55a24;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-running {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .status-stopped {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .server-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }
        
        .stat-card h6 {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .stat-card .value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .progress {
            height: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            margin-top: 0.5rem;
        }
        
        .progress-bar {
            background: var(--accent);
        }

        .action-buttons {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 1000;
        }
        
        .action-button {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-button:hover {
            transform: scale(1.1);
        }
        
        .action-close {
            background: #ff5f57;
        }
        
        .action-minimize {
            background: #febc2e;
        }
        
        .action-maximize {
            background: #28c840;
        }
        
        /* CodeMirror customization */
        .CodeMirror {
            height: auto;
            min-height: 300px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
        }
        
        .editor-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            background: var(--bg-dark);
            padding: 20px;
        }
        
        .editor-fullscreen .CodeMirror {
            height: calc(100vh - 100px);
        }
        
        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-darker);
            border-radius: 4px 4px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }
        
        .editor-toolbar button {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .editor-toolbar button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .startup-command {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-darker);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
        }

        /* File Manager Styles */
        .file-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .file-item:hover .file-actions {
            opacity: 1;
        }

        .file-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: 0.2rem;
        }

        .file-actions .btn-outline-info {
            color: #17a2b8;
            border-color: #17a2b8;
        }

        .file-actions .btn-outline-info:hover {
            color: #fff;
            background-color: #17a2b8;
            border-color: #17a2b8;
        }

        .file-actions .btn-outline-warning {
            color: #ffc107;
            border-color: #ffc107;
        }

        .file-actions .btn-outline-warning:hover {
            color: #000;
            background-color: #ffc107;
            border-color: #ffc107;
        }

        .file-actions .btn-outline-danger {
            color: #dc3545;
            border-color: #dc3545;
        }

        .file-actions .btn-outline-danger:hover {
            color: #fff;
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .file-actions .btn-outline-primary {
            color: #ff6b35;
            border-color: #ff6b35;
        }

        .file-actions .btn-outline-primary:hover {
            color: #fff;
            background-color: #ff6b35;
            border-color: #ff6b35;
        }

        /* Modal Styles */
        .modal-fullscreen {
            padding: 0 !important;
        }

        .modal-fullscreen .modal-dialog {
            max-width: 100% !important;
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
        }

        .modal-fullscreen .modal-content {
            height: 100% !important;
            border: 0 !important;
            border-radius: 0 !important;
        }

        .modal-fullscreen .modal-body {
            height: calc(100vh - 60px) !important;
            padding: 0 !important;
        }

        .modal-fullscreen .CodeMirror {
            height: 100% !important;
        }

        /* Editor Styles */
        .editor-toolbar {
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-toolbar button {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }

        .editor-toolbar button:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .editor-toolbar button:last-child {
            margin-right: 0;
        }

        #viewFileContent .CodeMirror,
        #editFileContent .CodeMirror {
            height: calc(100vh - 200px);
            border: none;
        }

        .modal-fullscreen #viewFileContent .CodeMirror,
        .modal-fullscreen #editFileContent .CodeMirror {
            height: calc(100vh - 120px);
        }

        /* File Icons */
        .file-item i.fa-folder {
            color: #ffd700;
        }

        .file-item i.fa-file {
            color: #ff6b35;
        }

        .file-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .file-item i {
            margin-right: 0.5rem;
            width: 1.25rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="fas fa-fire me-2"></i>Flare Panel
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-server me-1"></i>{{ server_name }}
                </span>
                <a class="nav-link" href="{{ url_for('dashboard') }}">
                    <i class="fas fa-arrow-left me-1"></i>Back
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Server Status and Stats -->
        <div class="server-stats">
            <div class="stat-card">
                <h6>MEMORY USAGE</h6>
                <div class="value">62% (4.88GB / 7.92GB)</div>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 62%"></div>
                </div>
            </div>
            <div class="stat-card">
                <h6>CPU USAGE</h6>
                <div class="value">5%</div>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 5%"></div>
                </div>
            </div>
            <div class="stat-card">
                <h6>STATUS</h6>
                <div class="value">
                    <span class="status-indicator {{ 'status-running' if server.status == 'running' else 'status-stopped' }}">
                        <i class="fas fa-circle me-2"></i>{{ server.status.upper() }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="console-tab" data-bs-toggle="tab" data-bs-target="#console" type="button" role="tab">
                    <i class="fas fa-terminal me-2"></i>Console
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">
                    <i class="fas fa-folder me-2"></i>File Manager
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                    <i class="fas fa-cog me-2"></i>Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab">
                    <i class="fas fa-database me-2"></i>Backup
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Console Tab -->
            <div class="tab-pane fade show active" id="console" role="tabpanel">
                <div class="action-buttons">
                    <button class="action-button action-close" title="Close"></button>
                    <button class="action-button action-minimize" title="Minimize"></button>
                    <button class="action-button action-maximize" title="Maximize"></button>
                </div>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Console</h5>
                        <div>
                            <button class="btn btn-sm btn-primary me-2" onclick="startServer()">
                                <i class="fas fa-play me-1"></i>Start
                            </button>
                            <button class="btn btn-sm btn-danger me-2" onclick="stopServer()">
                                <i class="fas fa-stop me-1"></i>Stop
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="restartServer()">
                                <i class="fas fa-redo me-1"></i>Restart
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="console-container" id="consoleOutput">
                            <!-- Console output will be loaded here -->
                        </div>
                        <div class="p-3 border-top">
                            <form id="commandForm" class="d-flex">
                                <input type="text" class="form-control console-input me-2" id="commandInput" 
                                       placeholder="Type a command..." autocomplete="off">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Manager Tab -->
            <div class="tab-pane fade" id="files" role="tabpanel">
                <div class="action-buttons">
                    <button class="action-button action-close" title="Close"></button>
                    <button class="action-button action-minimize" title="Minimize"></button>
                    <button class="action-button action-maximize" title="Maximize"></button>
                </div>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">File Manager</h5>
                        <div>
                            <button class="btn btn-sm btn-primary me-2" onclick="uploadFile()">
                                <i class="fas fa-upload me-1"></i>Upload
                            </button>
                            <button class="btn btn-sm btn-success" onclick="createFolder()">
                                <i class="fas fa-folder-plus me-1"></i>New Folder
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item">
                                    <a href="#" onclick="navigateToPath('/')">
                                        <i class="fas fa-home me-1"></i>Root
                                    </a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a href="#" onclick="navigateToPath('/servers')">servers</a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a href="#" onclick="navigateToPath('/servers/{{ server_name }}')">{{ server_name }}</a>
                                </li>
                                <span id="currentPath"></span>
                            </ol>
                        </nav>
                        <div class="file-manager mt-3">
                            <ul class="file-list" id="fileList">
                                <!-- File list will be loaded here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="action-buttons">
                    <button class="action-button action-close" title="Close"></button>
                    <button class="action-button action-minimize" title="Minimize"></button>
                    <button class="action-button action-maximize" title="Maximize"></button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Server Settings</h5>
                    </div>
                    <div class="card-body">
                        <form id="settingsForm">
                            <div class="mb-3">
                                <label class="form-label">Server Name</label>
                                <input type="text" class="form-control console-input" id="serverNameInput" value="{{ server.name }}">
                                <small class="text-muted">Change the name of your server. This will also rename the server folder.</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Port</label>
                                <input type="number" class="form-control console-input" id="serverPortInput" value="{{ server.port }}">
                                <small class="text-muted">Change the port your server runs on.</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Startup Command</label>
                                <div class="input-group">
                                    <input type="text" class="form-control startup-command" id="startupCommand" 
                                           value="{{ server.command }}">
                                    <button type="button" class="btn btn-warning" onclick="testStartupCommand()">
                                        <i class="fas fa-play me-1"></i>Test
                                    </button>
                                </div>
                                <small class="text-muted">Command to start your server. Example: python app.py</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Server Type</label>
                                <input type="text" class="form-control console-input" value="{{ server.server_type }}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Server Information</label>
                                <div class="server-info">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="info-item">
                                                <i class="fas fa-network-wired me-2"></i>
                                                <span>Host: {{ server.host }}</span>
                                            </div>
                                            <div class="info-item">
                                                <i class="fas fa-plug me-2"></i>
                                                <span>Port: {{ server.port }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Save Changes
                                </button>
                                <button type="button" class="btn btn-danger ms-2" onclick="deleteServer()">
                                    <i class="fas fa-trash me-1"></i>Delete Server
                                </button>
                            </div>
                        </form>
                    </div>

                    <style>
                    .server-info {
                        background: var(--bg-darker);
                        border: 1px solid var(--border-color);
                        border-radius: 0.5rem;
                        padding: 1rem;
                    }

                    .info-item {
                        padding: 0.5rem;
                        border-bottom: 1px solid var(--border-color);
                        color: var(--text-secondary);
                    }

                    .info-item:last-child {
                        border-bottom: none;
                    }

                    .info-item i {
                        width: 20px;
                        color: var(--accent);
                    }

                    .btn-group .btn {
                        border: 1px solid var(--border-color);
                    }

                    .btn-group .btn:hover {
                        border-color: var(--accent);
                    }
                    </style>

                    <script>
                    // Update server uptime
                    function updateUptime() {
                        if (server.start_time) {
                            const start = new Date(server.start_time);
                            const now = new Date();
                            const diff = now - start;
                            const hours = Math.floor(diff / (1000 * 60 * 60));
                            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            document.getElementById('serverUptime').textContent = `${hours}h ${minutes}m`;
                        }
                    }

                    // Update memory usage
                    function updateMemoryUsage() {
                        fetch(`/api/server_stats/${serverName}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    document.getElementById('memoryUsage').textContent = 
                                        `${data.memory_usage}MB / ${data.memory_limit}MB`;
                                }
                            });
                    }

                    // Backup server
                    function backupServer() {
                        fetch(`/api/backup_server/${serverName}`, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Server backup created successfully!');
                                } else {
                                    alert('Error creating backup: ' + data.error);
                                }
                            });
                    }

                    // View logs
                    function viewLogs() {
                        fetch(`/api/server_logs/${serverName}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Show logs in a modal
                                    let modal = new bootstrap.Modal(document.getElementById('logsModal'));
                                    document.getElementById('logsContent').textContent = data.logs;
                                    modal.show();
                                }
                            });
                    }

                    // Clear logs
                    function clearLogs() {
                        if (confirm('Are you sure you want to clear all logs?')) {
                            fetch(`/api/clear_logs/${serverName}`, { method: 'POST' })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        alert('Logs cleared successfully!');
                                    } else {
                                        alert('Error clearing logs: ' + data.error);
                                    }
                                });
                        }
                    }

                    // Update stats periodically
                    setInterval(updateUptime, 60000);
                    setInterval(updateMemoryUsage, 30000);
                    updateUptime();
                    updateMemoryUsage();
                    </script>
                </div>
            </div>

            <!-- Backup Tab -->
            <div class="tab-pane fade" id="backup" role="tabpanel">
                <div class="action-buttons">
                    <button class="action-button action-close" title="Close"></button>
                    <button class="action-button action-minimize" title="Minimize"></button>
                    <button class="action-button action-maximize" title="Maximize"></button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Backup & Restore</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary me-2" onclick="showBackupModal()">
                                <i class="fas fa-save me-1"></i>Backup Server
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="showRestoreModal()">
                                <i class="fas fa-upload me-1"></i>Restore from Backup
                            </button>
                        </div>
                        <div class="mb-3">
                            <h6>Available Backups</h6>
                            <ul class="list-group" id="backupList">
                                <!-- Backups will be loaded here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload File Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Upload File</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="uploadForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Select File</label>
                            <input type="file" class="form-control console-input" id="fileInput" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Folder Modal -->
    <div class="modal fade" id="folderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Folder</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="folderForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Folder Name</label>
                            <input type="text" class="form-control console-input" id="folderName" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div class="modal fade" id="logsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Server Logs</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="logsContent" class="console-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Name Modal -->
    <div class="modal fade" id="backupNameModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Create Backup</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Backup Name</label>
                        <input type="text" class="form-control console-input" id="backupNameInput" placeholder="e.g. my-backup">
                        <small class="text-muted">Use only letters, numbers, dash, and underscore.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmBackup()">Create Backup</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script>
        // Server Control Functions
        let serverName = '{{ server_name }}';
        let currentPath = '/';

        function updatePath(path) {
            currentPath = path;
            let relativePath = path.replace(`/servers/${serverName}`, '');
            let segments = relativePath.split('/').filter(s => s);
            let pathHtml = '';
            
            if (segments.length > 0) {
                segments.forEach((segment, index) => {
                    let fullPath = `/servers/${serverName}/${segments.slice(0, index + 1).join('/')}`;
                    pathHtml += `
                        <li class="breadcrumb-item">
                            <a href="#" onclick="navigateToPath('${fullPath}')">${segment}</a>
                        </li>
                    `;
                });
            }
            
            document.getElementById('currentPath').innerHTML = pathHtml;
        }

        function navigateToPath(path) {
            updatePath(path);
            loadFileList(path);
        }

        function startServer() {
            fetch(`/start_server/${serverName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateServerStatus();
                    }
                });
        }

        function stopServer() {
            fetch(`/stop_server/${serverName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateServerStatus();
                    }
                });
        }

        function restartServer() {
            stopServer().then(() => {
                setTimeout(startServer, 2000);
            });
        }

        // Console Functions
        let consoleOutput = document.getElementById('consoleOutput');
        let commandInput = document.getElementById('commandInput');
        let commandForm = document.getElementById('commandForm');

        function updateConsole() {
            fetch(`/api/console_logs/${serverName}`)
                .then(response => response.json())
                .then(data => {
                    consoleOutput.innerHTML = data.logs.join('<br>');
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                });
        }

        commandForm.addEventListener('submit', function(e) {
            e.preventDefault();
            let command = commandInput.value;
            if (command) {
                fetch(`/api/send_command/${serverName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command })
                })
                .then(response => response.json())
                .then(data => {
                    commandInput.value = '';
                    updateConsole();
                });
            }
        });

        // File Manager Functions
        function loadFileList(path = '/') {
            fetch(`/api/files/${serverName}?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    let fileList = document.getElementById('fileList');
                    fileList.innerHTML = data.files.map(file => `
                        <li class="file-item">
                            <div class="d-flex align-items-center">
                                <i class="fas ${file.is_dir ? 'fa-folder' : 'fa-file'}"></i>
                                <span class="file-name ms-2">${file.name}</span>
                                ${file.size ? `<span class="file-size ms-2 text-muted">(${file.size})</span>` : ''}
                            </div>
                            <div class="file-actions">
                                ${file.is_dir ? `
                                    <button class="btn btn-sm btn-outline-primary" onclick="navigateToPath('${currentPath}/${file.name}')" title="Open">
                                        <i class="fas fa-folder-open"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="renameFile('${file.path}')" title="Rename">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="moveFile('${file.path}')" title="Move">
                                        <i class="fas fa-arrows-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('${file.path}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : `
                                    <button class="btn btn-sm btn-outline-info" onclick="viewFile('${file.path}')" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="editFile('${file.path}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="downloadFile('${file.path}')" title="Download">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="renameFile('${file.path}')" title="Rename">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="moveFile('${file.path}')" title="Move">
                                        <i class="fas fa-arrows-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('${file.path}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                `}
                            </div>
                        </li>
                    `).join('');
                });
        }

        // Load requirements file content
        function loadRequirementsFile() {
            let fileName = document.getElementById('requirementsFileName').value;
            fetch(`/api/read_requirements/${serverName}?filename=${encodeURIComponent(fileName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        requirementsEditor.setValue(data.content);
                    }
                });
        }

        // Initialize CodeMirror editors
        let requirementsEditor = CodeMirror.fromTextArea(document.getElementById('requirementsContent'), {
            mode: 'text/plain',
            theme: 'dracula',
            lineNumbers: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 4,
            tabSize: 4,
            lineWrapping: true,
            extraKeys: {
                'Ctrl-S': function(cm) {
                    saveSettings();
                },
                'Cmd-S': function(cm) {
                    saveSettings();
                }
            }
        });

        // Toggle fullscreen mode for requirements editor
        function toggleRequirementsFullscreen() {
            let container = requirementsEditor.getWrapperElement().parentNode;
            container.classList.toggle('editor-fullscreen');
            requirementsEditor.refresh();
        }

        // Format requirements
        function formatRequirements() {
            let content = requirementsEditor.getValue();
            let lines = content.split('\n').filter(line => line.trim());
            lines.sort();
            requirementsEditor.setValue(lines.join('\n'));
        }

        // Test startup command
        function testStartupCommand() {
            let command = document.getElementById('startupCommand').value;
            fetch(`/api/test_startup/${serverName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ command: command })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Command test successful!');
                } else {
                    alert('Error testing command: ' + data.error);
                }
            });
        }

        // Save settings
        function saveSettings(e) {
            if (e) e.preventDefault();
            let newName = document.getElementById('serverNameInput').value.trim();
            let newPort = document.getElementById('serverPortInput').value.trim();
            let command = document.getElementById('startupCommand').value;
            fetch(`/api/save_settings/${serverName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    new_name: newName,
                    new_port: newPort,
                    startup_command: command
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Settings saved successfully!');
                    if (data.reload) {
                        window.location.href = `/manage/${newName}`;
                    }
                } else {
                    alert('Error saving settings: ' + data.error);
                }
            });
        }

        // Install dependencies
        function installDependencies() {
            fetch(`/api/install_dependencies/${serverName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requirements_file: document.getElementById('requirementsFileName').value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Dependencies installed successfully!');
                } else {
                    alert('Error installing dependencies: ' + data.error);
                }
            });
        }

        // Add event listeners
        document.getElementById('settingsForm').addEventListener('submit', saveSettings);
        document.getElementById('requirementsFileName').addEventListener('change', loadRequirementsFile);

        // Initial load
        navigateToPath(`/servers/${serverName}`);
        updateConsole();
        setInterval(updateConsole, 2000);
        // Initial load of requirements
        loadRequirementsFile();

        // File Operations Functions
        function deleteFile(path) {
            if (confirm('Are you sure you want to delete this file/folder?')) {
                fetch(`/server_delete_file/${serverName}?path=${encodeURIComponent(path)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadFileList(currentPath);
                        } else {
                            alert('Error deleting file: ' + data.error);
                        }
                    });
            }
        }

        function moveFile(path) {
            let newPath = prompt('Enter new path (relative to server root):', path);
            if (newPath && newPath !== path) {
                fetch(`/server_rename_file/${serverName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        old_path: path,
                        new_name: newPath.split('/').pop(),
                        current_path: currentPath
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadFileList(currentPath);
                    } else {
                        alert('Error moving file: ' + data.error);
                    }
                });
            }
        }

        // View File Function
        function viewFile(path) {
            fetch(`/api/read_file?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let viewModal = new bootstrap.Modal(document.getElementById('viewFileModal'));
                        let viewEditor = CodeMirror(document.getElementById('viewFileContent'), {
                            value: data.content,
                            mode: getFileMode(path),
                            theme: 'dracula',
                            lineNumbers: true,
                            readOnly: true,
                            viewportMargin: Infinity,
                            lineWrapping: true
                        });
                        viewModal.show();
                        setTimeout(() => viewEditor.refresh(), 10);
                    }
                });
        }

        // Edit File Function
        function editFile(path) {
            fetch(`/api/read_file?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let editModal = new bootstrap.Modal(document.getElementById('editFileModal'));
                        let container = document.getElementById('editFileContent');
                        container.innerHTML = `
                            <div class="editor-toolbar">
                                <div class="d-flex align-items-center">
                                    <button type="button" onclick="toggleEditFullscreen()" title="Toggle Fullscreen">
                                        <i class="fas fa-expand me-1"></i>
                                    </button>
                                    <button type="button" onclick="formatCode()" title="Format Code">
                                        <i class="fas fa-magic me-1"></i>
                                    </button>
                                    <button type="button" onclick="toggleWordWrap()" title="Toggle Word Wrap">
                                        <i class="fas fa-align-left me-1"></i>
                                    </button>
                                    <select class="form-select form-select-sm ms-2" onchange="changeEditorTheme(this.value)" style="width: auto;">
                                        <option value="dracula">Dracula</option>
                                        <option value="monokai">Monokai</option>
                                        <option value="material">Material</option>
                                        <option value="nord">Nord</option>
                                    </select>
                                </div>
                                <div>
                                    <button type="button" onclick="saveFile('${path}')" title="Save (Ctrl/Cmd + S)">
                                        <i class="fas fa-save me-1"></i>Save
                                    </button>
                                </div>
                            </div>
                            <div id="editFileEditor"></div>
                        `;
                        
                        window.currentEditEditor = CodeMirror(document.getElementById('editFileEditor'), {
                            value: data.content,
                            mode: getFileMode(path),
                            theme: 'dracula',
                            lineNumbers: true,
                            autoCloseBrackets: true,
                            matchBrackets: true,
                            indentUnit: 4,
                            tabSize: 4,
                            lineWrapping: true,
                            foldGutter: true,
                            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                            extraKeys: {
                                'Ctrl-S': function() { saveFile(path); },
                                'Cmd-S': function() { saveFile(path); },
                                'Tab': function(cm) {
                                    if (cm.somethingSelected()) {
                                        cm.indentSelection('add');
                                    } else {
                                        cm.replaceSelection('    ', 'end');
                                    }
                                }
                            }
                        });
                        editModal.show();
                        setTimeout(() => window.currentEditEditor.refresh(), 10);
                    }
                });
        }

        // Save File Function
        function saveFile(path) {
            let content = window.currentEditEditor.getValue();
            fetch(`/api/save_file`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    path: path,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('File saved successfully!');
                } else {
                    alert('Error saving file: ' + data.error);
                }
            });
        }

        // Toggle Edit Fullscreen
        function toggleEditFullscreen() {
            let container = document.getElementById('editFileModal');
            container.classList.toggle('modal-fullscreen');
            if (window.currentEditEditor) {
                window.currentEditEditor.refresh();
            }
        }

        // Get File Mode for CodeMirror
        function getFileMode(filename) {
            const extensions = {
                'py': 'python',
                'js': 'javascript',
                'html': 'xml',
                'css': 'css',
                'json': 'javascript'
            };
            let ext = filename.split('.').pop().toLowerCase();
            return extensions[ext] || 'text/plain';
        }

        // Refresh file list
        function refreshFiles() {
            loadFileList(currentPath);
        }

        // Filter files based on search
        function filterFiles() {
            const searchTerm = document.getElementById('fileSearch').value.toLowerCase();
            const fileItems = document.querySelectorAll('.file-item');
            
            fileItems.forEach(item => {
                const fileName = item.querySelector('.file-name').textContent.toLowerCase();
                if (fileName.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Clear search
        function clearSearch() {
            document.getElementById('fileSearch').value = '';
            filterFiles();
        }

        // Add drag and drop support
        const fileManager = document.querySelector('.file-manager');
        
        fileManager.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileManager.classList.add('drag-over');
        });

        fileManager.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileManager.classList.remove('drag-over');
        });

        fileManager.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileManager.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const formData = new FormData();
                for (let file of files) {
                    formData.append('file', file);
                }
                formData.append('path', currentPath);

                fetch(`/server_upload_file/${serverName}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadFileList(currentPath);
                    } else {
                        alert('Error uploading files: ' + data.error);
                    }
                });
            }
        });

        // Format code in editor
        function formatCode() {
            if (window.currentEditEditor) {
                const content = window.currentEditEditor.getValue();
                try {
                    // Basic indentation formatting
                    const formatted = js_beautify(content, {
                        indent_size: 4,
                        indent_char: ' ',
                        max_preserve_newlines: 2
                    });
                    window.currentEditEditor.setValue(formatted);
                } catch (e) {
                    console.log('Formatting failed:', e);
                }
            }
        }

        // Toggle word wrap
        function toggleWordWrap() {
            if (window.currentEditEditor) {
                const current = window.currentEditEditor.getOption('lineWrapping');
                window.currentEditEditor.setOption('lineWrapping', !current);
            }
        }

        // Change editor theme
        function changeEditorTheme(theme) {
            if (window.currentEditEditor) {
                window.currentEditEditor.setOption('theme', theme);
            }
        }

        // Backup Tab Functions
        function loadBackups() {
            fetch(`/api/list_backups`)
                .then(response => response.json())
                .then(data => {
                    let backupList = document.getElementById('backupList');
                    if (!backupList) return;
                    backupList.innerHTML = (data.backups || []).map(backup => `
                        <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-database me-2"></i>${backup.filename}
                                <small class="text-muted ms-2">${backup.size_mb} MB</small>
                                <small class="text-muted ms-2">${backup.created}</small>
                            </span>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-success" onclick="restoreBackup('${backup.filename}')">
                                    <i class="fas fa-upload me-1"></i>Restore
                                </button>
                                <a class="btn btn-sm btn-outline-primary" href="/backups/${backup.filename}" download>
                                    <i class="fas fa-download me-1"></i>Download
                                </a>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup('${backup.filename}')">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        </li>
                    `).join('');
                });
        }
        function showBackupModal() {
            document.getElementById('backupNameInput').value = '';
            let modal = new bootstrap.Modal(document.getElementById('backupNameModal'));
            modal.show();
        }
        function confirmBackup() {
            let name = document.getElementById('backupNameInput').value.trim();
            if (!/^[\w-]+$/.test(name)) {
                alert('Invalid backup name. Use only letters, numbers, dash, and underscore.');
                return;
            }
            backupServer(name);
            bootstrap.Modal.getInstance(document.getElementById('backupNameModal')).hide();
        }
        function backupServer(customName) {
            fetch(`/api/backup_server/${serverName}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ backup_name: customName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Server backup created successfully!');
                    loadBackups();
                } else {
                    alert('Error creating backup: ' + data.error);
                }
            });
        }
        function restoreBackup(filename) {
            fetch(`/api/restore_server/${serverName}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ backup_file: filename })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Server restored successfully!');
                } else {
                    alert('Error restoring backup: ' + data.error);
                }
            });
        }
        function showRestoreModal() {
            loadBackups();
            // Optionally show a modal if you want a separate restore modal
        }
        function deleteBackup(filename) {
            if (!confirm('Are you sure you want to delete this backup?')) return;
            fetch(`/api/delete_backup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Backup deleted successfully!');
                    loadBackups();
                } else {
                    alert('Error deleting backup: ' + (data.error || 'Unknown error'));
                }
            });
        }
        // Load backups when backup tab is shown
        document.getElementById('backup-tab').addEventListener('shown.bs.tab', loadBackups);

        function deleteServer() {
            if (confirm('Are you sure you want to delete this server? This action cannot be undone!')) {
                window.location.href = `/delete_server/${serverName}`;
            }
        }
    </script>

    <!-- View File Modal -->
    <div class="modal fade" id="viewFileModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">View File</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="viewFileContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit File Modal -->
    <div class="modal fade" id="editFileModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title">Edit File</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="editFileContent"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 